---
layout: post
title: Docx4J word模板实战
description: Docx4J word模板实战
---

# 背景：最近要生成word文档，刚开始考虑了POI，但是POI插入图片好像有bug，而且好像比较难用，听说Docx4J比POI容易一些而且功能更强大，遂打算将Docx4J用到项目中去。

## 使用准备 

1. 在gradle中引入依赖

``` groovy

            "org.docx4j:docx4j:3.3.1",
            "org.docx4j:docx4j-export-fo:3.3.1",

```

2. 一个能解压的软件 如：7zip

3. 能格式化XML文件的文本编辑器 如：Notepad++(需要装一个插件：XML Tools) 将xml的默认打开方式提前设置为用此软件打开

## 第一部分 简单文本替换

### 1. 将需要生成的word文件保存为docx格式
### 2. 在需要替换字符的地方写上${parameter} (注意：这里要根据你的需要设定参数，parameter只是示例)
### 3. 使用7zip打开docx文件，即打开压缩包(注意：不是解压，解压了就压缩不回去了)
### 4. 进入word文件夹，打开document.xml
### 5. 点击Notepad++菜单栏中的插件：XMl Tools,然后点击 pretty XML With Line Brekes格式化XMl文件，或者选择你喜欢的方式
### 6. 第二步写的${parameter}在xml中可能为下面的样子
```XML
<w:r>
    <w:rPr>
        <w:rFonts w:hint="eastAsia"/>
        <w:b/>
        <w:szCs w:val="21"/>
    </w:rPr>
    <w:t>${</w:t>
</w:r>
<w:r>
    <w:rPr>
        <w:rFonts w:hint="eastAsia"/>
        <w:b/>
        <w:szCs w:val="21"/>
    </w:rPr>
    <w:t>parameter</w:t>
</w:r>
<w:r>
    <w:rPr>
        <w:rFonts w:hint="eastAsia"/>
        <w:b/>
        <w:szCs w:val="21"/>
    </w:rPr>
    <w:t>}</w:t>
</w:r>
```
### 7. 将他们"撮合"到一个中去，如下：
```XML
<w:r>
    <w:rPr>
        <w:rFonts w:hint="eastAsia"/>
        <w:b/>
        <w:szCs w:val="21"/>
    </w:rPr>
    <w:t>${parameter}</w:t>
</w:r>
```
### 8. 然后 保存文件，切到7zip，这时7zip会提醒你更新压缩包的的文件，点击确定就行了
### 9. 然后就可以替换参数生成简单的word文档了！

``` java
    /**
     * 创建Docx的主方法
     *
     * @param templatePath        模板docx路径
     * @param parameters          参数和值
     * @param paragraphParameters 段落参数
     * @param imageParameters     书签和图片
     * @return
     */
    private static WordprocessingMLPackage CreateWordprocessingMLPackageFromTemplate(String templatePath,
                                                                                     HashMap<String, String> parameters,
                                                                                     HashMap<String, String> paragraphParameters,
                                                                                     HashMap<String, String> imageParameters)
            throws Exception {
        @Cleanup InputStream docxStream = DocxProducer.class.getResourceAsStream(templatePath);
        WordprocessingMLPackage wordMLPackage = WordprocessingMLPackage.load(docxStream);
        MainDocumentPart documentPart = wordMLPackage.getMainDocumentPart();

        //第一步 替换字符参数
        if (parameters != null) {
            replaceParameters(documentPart, parameters);
        }

        ...............
        return wordMLPackage;
    }
```


``` java
    /**
     * 替换模板中的参数
     *
     * @param documentPart
     * @param parameters
     * @throws JAXBException
     * @throws Docx4JException
     */
    private static void replaceParameters(MainDocumentPart documentPart,
                                          HashMap<String, String> parameters)
            throws JAXBException, Docx4JException {
        documentPart.variableReplace(parameters);
    }
```